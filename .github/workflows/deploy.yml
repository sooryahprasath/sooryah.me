name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Production Deployment
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy Updates
        run: |
          # 1. Build the image locally
          # We use build because the code is already on the server via checkout
          docker compose build

          # 2. Restart containers
          # Force recreate ensures the new image (with new port 8090) is applied
          docker compose up -d --force-recreate

      - name: Verification
        run: |
          echo "⏳ Waiting 10s for application boot..."
          sleep 10
          
          # Check if container is actually running
          if [ "$(docker inspect -f '{{.State.Running}}' portfolio-web)" = "true" ]; then
              echo "✅ Container is online."
              
              # Verify the HTML file exists inside the static directory
              docker exec portfolio-web ls -l /app/static/index.html
              echo "✅ File structure verified."
          else
              echo "❌ CRITICAL: Container crashed. Fetching last 20 logs..."
              docker logs --tail 20 portfolio-web
              exit 1
          fi