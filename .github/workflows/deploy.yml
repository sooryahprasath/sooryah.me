name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Production Deployment
    runs-on: self-hosted
    steps:
      # --- Fix Workspace Permissions ---
      - name: üîß Fix Workspace Permissions
        run: |
          echo "Running cleanup as root..."
          sudo chown -R $USER:$USER $GITHUB_WORKSPACE
          sudo rm -rf $GITHUB_WORKSPACE/*

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Pre-flight Check (InfluxDB)
        run: |
          echo "üîç Checking InfluxDB status..."
          if [ "$(docker inspect -f '{{.State.Running}}' influxdb)" = "true" ]; then
              echo "‚úÖ InfluxDB is running."
          else
              echo "‚ö†Ô∏è InfluxDB is DOWN. Attempting to auto-start..."
              docker start influxdb
              sleep 5
              if [ "$(docker inspect -f '{{.State.Running}}' influxdb)" = "true" ]; then
                  echo "‚úÖ InfluxDB restarted successfully."
              else
                  echo "‚ùå CRITICAL: Could not start InfluxDB. Deployment aborted."
                  exit 1
              fi
          fi

      - name: Create .env file
        run: |
          echo "INFLUX_URL=${{ secrets.INFLUX_URL }}" >> .env
          echo "INFLUX_TOKEN=${{ secrets.INFLUX_TOKEN }}" >> .env
          echo "INFLUX_ORG=${{ secrets.INFLUX_ORG }}" >> .env
          echo "INFLUX_BUCKET=${{ secrets.INFLUX_BUCKET }}" >> .env
          echo "RADAR_IP=${{ secrets.RADAR_IP }}" >> .env
          echo "CAMERA_USER=${{ secrets.CAMERA_USER }}" >> .env
          echo "CAMERA_PASS=${{ secrets.CAMERA_PASS }}" >> .env
          echo "CAMERA_IP=${{ secrets.CAMERA_IP }}" >> .env

      - name: Inject Secrets into MediaMTX Config
        env: 
          CAMERA_USER: ${{ secrets.CAMERA_USER }}
          CAMERA_PASS: ${{ secrets.CAMERA_PASS }}
          CAMERA_IP: ${{ secrets.CAMERA_IP }}
        run: |
          echo "‚öôÔ∏è Generating mediamtx.yml from template..."
          envsubst < mediamtx.template.yml > mediamtx.yml

      - name: Deploy Updates (Main Stack)
        run: |
          docker compose build
          docker compose up -d --force-recreate

      - name: Verification (Main Stack)
        run: |
          echo "‚è≥ Waiting 10s for application boot..."
          sleep 10
          if [ "$(docker inspect -f '{{.State.Running}}' portfolio-web)" = "true" ]; then
              echo "‚úÖ Container is online."
          else
              echo "‚ùå CRITICAL: Container crashed. Fetching logs..."
              docker logs --tail 20 portfolio-web
              exit 1
          fi

      # --- NEW STEPS: TRAFFIC AI ENGINE DEPLOYMENT ---
      - name: ü§ñ Deploy Traffic Engine via Docker
        run: |
          echo "Building and launching Traffic Engine..."
          # Navigate to the specific directory
          cd traffic_engine
          
          # 1. Ensure the persistent file exists so Docker doesn't crash on mount
          touch history.json
          
          # 2. Safely stop and remove the old container if it exists
          docker stop traffic_engine_app || true
          docker rm traffic_engine_app || true
          
          # 3. Build the fresh image
          docker build -t traffic_engine .
          
          # 4. Run the new container
          docker run -d \
            --name traffic_engine_app \
            --restart unless-stopped \
            -p 5000:5000 \
            -v $(pwd)/history.json:/app/history.json \
            traffic_engine

      - name: Verification (Traffic Engine)
        run: |
          echo "‚è≥ Waiting 5s for Traffic Engine boot..."
          sleep 5
          if [ "$(docker inspect -f '{{.State.Running}}' traffic_engine_app)" = "true" ]; then
              echo "‚úÖ Traffic Engine is online and listening on Port 5000."
          else
              echo "‚ùå CRITICAL: Traffic Engine crashed. Fetching logs..."
              docker logs --tail 20 traffic_engine_app
              exit 1
          fi