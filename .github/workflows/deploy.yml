name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Production Deployment
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- NEW STEP: Database Health Check ---
      - name: Pre-flight Check (InfluxDB)
        run: |
          echo "üîç Checking InfluxDB status..."
          if [ "$(docker inspect -f '{{.State.Running}}' influxdb)" = "true" ]; then
              echo "‚úÖ InfluxDB is running."
          else
              echo "‚ö†Ô∏è InfluxDB is DOWN. Attempting to auto-start..."
              docker start influxdb
              sleep 5
              
              # Double check
              if [ "$(docker inspect -f '{{.State.Running}}' influxdb)" = "true" ]; then
                  echo "‚úÖ InfluxDB restarted successfully."
              else
                  echo "‚ùå CRITICAL: Could not start InfluxDB. Deployment aborted."
                  exit 1
              fi
          fi

      - name: Create .env file
        run: |
          echo "INFLUX_URL=${{ secrets.INFLUX_URL }}" >> .env
          echo "INFLUX_TOKEN=${{ secrets.INFLUX_TOKEN }}" >> .env
          echo "INFLUX_ORG=${{ secrets.INFLUX_ORG }}" >> .env
          echo "INFLUX_BUCKET=${{ secrets.INFLUX_BUCKET }}" >> .env
          echo "RADAR_IP=${{ secrets.RADAR_IP }}" >> .env
          echo "CAMERA_USER=${{ secrets.CAMERA_USER }}" >> .env
          echo "CAMERA_PASS=${{ secrets.CAMERA_PASS }}" >> .env
          echo "CAMERA_IP=${{ secrets.CAMERA_IP }}" >> .env

      - name: Deploy Updates
        run: |
          docker compose build
          docker compose up -d --force-recreate

      - name: Verification
        run: |
          echo "‚è≥ Waiting 10s for application boot..."
          sleep 10
          if [ "$(docker inspect -f '{{.State.Running}}' portfolio-web)" = "true" ]; then
              echo "‚úÖ Container is online."
              docker exec portfolio-web ls -l /app/static/index.html
          else
              echo "‚ùå CRITICAL: Container crashed. Fetching logs..."
              docker logs --tail 20 portfolio-web
              exit 1
          fi