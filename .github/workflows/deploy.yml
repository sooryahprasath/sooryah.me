name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Production Deployment
    runs-on: self-hosted
    steps:
      # --- Fix Workspace Permissions ---
      - name: üîß Fix Workspace Permissions
        run: |
          echo "Running cleanup as root..."
          sudo chown -R $USER:$USER $GITHUB_WORKSPACE
          sudo rm -rf $GITHUB_WORKSPACE/*

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Pre-flight Check (InfluxDB)
        run: |
          echo "üîç Checking InfluxDB status..."
          if [ "$(docker inspect -f '{{.State.Running}}' influxdb)" = "true" ]; then
              echo "‚úÖ InfluxDB is running."
          else
              echo "‚ö†Ô∏è InfluxDB is DOWN. Attempting to auto-start..."
              docker start influxdb
              sleep 5
              if [ "$(docker inspect -f '{{.State.Running}}' influxdb)" = "true" ]; then
                  echo "‚úÖ InfluxDB restarted successfully."
              else
                  echo "‚ùå CRITICAL: Could not start InfluxDB. Deployment aborted."
                  exit 1
              fi
          fi

      - name: Create .env file
        run: |
          echo "INFLUX_URL=${{ secrets.INFLUX_URL }}" >> .env
          echo "INFLUX_TOKEN=${{ secrets.INFLUX_TOKEN }}" >> .env
          echo "INFLUX_ORG=${{ secrets.INFLUX_ORG }}" >> .env
          echo "INFLUX_BUCKET=${{ secrets.INFLUX_BUCKET }}" >> .env
          echo "RADAR_IP=${{ secrets.RADAR_IP }}" >> .env
          echo "CAMERA_USER=${{ secrets.CAMERA_USER }}" >> .env
          echo "CAMERA_PASS=${{ secrets.CAMERA_PASS }}" >> .env
          echo "CAMERA_IP=${{ secrets.CAMERA_IP }}" >> .env
          echo "TUNNEL_TOKEN=${{ secrets.TUNNEL_TOKEN }}" >> .env

      - name: Inject Secrets into MediaMTX Config
        env: 
          CAMERA_USER: ${{ secrets.CAMERA_USER }}
          CAMERA_PASS: ${{ secrets.CAMERA_PASS }}
          CAMERA_IP: ${{ secrets.CAMERA_IP }}
        run: |
          echo "‚öôÔ∏è Generating mediamtx.yml from template..."
          envsubst < mediamtx.template.yml > mediamtx.yml

      - name: Deploy Updates (Unified Stack)
        run: |
          # This securely builds and deploys everything defined in docker-compose.yml
          docker compose build
          docker compose up -d --force-recreate

      - name: Verification (Main Web Container)
        run: |
          echo "‚è≥ Waiting 10s for application boot..."
          sleep 10
          if [ "$(docker inspect -f '{{.State.Running}}' portfolio-web)" = "true" ]; then
              echo "‚úÖ Main web container is online."
          else
              echo "‚ùå CRITICAL: Container crashed. Fetching logs..."
              docker logs --tail 20 portfolio-web
              exit 1
          fi
          
      - name: Verification (Traffic Engine Container)
        run: |
          if [ "$(docker inspect -f '{{.State.Running}}' traffic-engine)" = "true" ]; then
              echo "‚úÖ Traffic Engine is online."
          else
              echo "‚ùå CRITICAL: Traffic Engine crashed. Fetching logs..."
              docker logs --tail 20 traffic-engine
              exit 1
          fi