name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Production Deployment
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- NEW STEP: Create .env file from Secrets ---
      - name: Create .env file
        run: |
          echo "INFLUX_URL=${{ secrets.INFLUX_URL }}" >> .env
          echo "INFLUX_TOKEN=${{ secrets.INFLUX_TOKEN }}" >> .env
          echo "INFLUX_ORG=${{ secrets.INFLUX_ORG }}" >> .env
          echo "INFLUX_BUCKET=${{ secrets.INFLUX_BUCKET }}" >> .env
          echo "RADAR_IP=${{ secrets.RADAR_IP }}" >> .env

      - name: Deploy Updates
        run: |
          docker compose build
          docker compose up -d --force-recreate

      - name: Verification
        run: |
          echo "⏳ Waiting 10s for application boot..."
          sleep 10
          if [ "$(docker inspect -f '{{.State.Running}}' portfolio-web)" = "true" ]; then
              echo "✅ Container is online."
              docker exec portfolio-web ls -l /app/static/index.html
          else
              echo "❌ CRITICAL: Container crashed. Fetching logs..."
              docker logs --tail 20 portfolio-web
              exit 1
          fi